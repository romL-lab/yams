<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Configurer Yam's</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .config-box {
            background: #232628ee;
            border-radius: 14px;
            padding: 28px 18px 22px 18px;
            max-width: 480px;
            margin: 32px auto 0 auto;
            box-shadow: 0 3px 18px #172037aa;
            border: 1.5px solid #45494d;
        }
        .team-label { font-weight:600; color:#298bd7; }
        .team-names-row { display:flex; gap:18px; align-items:center; margin-bottom:12px;}
        .team-name-input { min-width:95px; padding:3px 8px; border-radius:7px; border:1px solid #bcd2e7; }
        .player-team-select { margin-left:12px; }
        label, select, input { font-size: 1.07em;}
        .yams-btn {
            background: #ffd647;
            color: #191d22;
            border-radius: 8px;
            border: none;
            padding: 10px 30px;
            font-size: 1.12em;
            font-weight: 700;
            cursor: pointer;
            margin-top: 18px;
        }
        .coeff-row {
            margin-top: 15px;
            background: #232628ee;
            border-radius: 9px;
            padding: 10px 16px;
            display: flex;
            gap: 16px;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 4px #17203755;
            border: 1px solid #394050;
            font-size:1.07em;
        }
        .coeff-row label { margin-bottom:0;}
    </style>
</head>
<body>
<div class="main-container">
    <div class="config-box">
        <h1>Configurer la partie Yam's</h1>
        <form id="config-form" autocomplete="off">
            <label for="num_players">Nombre de joueurs :</label>
            <select name="num_players" id="num_players" required onchange="updateFields()">
                <option value="2" selected>2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
            </select>
            <label for="num_teams" style="margin-left:18px;">Nombre d'équipes :</label>
            <select name="num_teams" id="num_teams" required onchange="updateFields()"></select>
            <div class="team-names-row" id="team-names-row"></div>
            <div id="players-fields"></div>
            <div class="coeffs-box">
				<span class="coeff-label">Coeff Montante<br><input type="number" id="coeff-montante" value="3" min="1" max="9"></span>
				<span class="coeff-label">Libre<br><input type="number" id="coeff-libre" value="1" min="1" max="9"></span>
				<span class="coeff-label">Sèche<br><input type="number" id="coeff-seche" value="4" min="1" max="9"></span>
				<span class="coeff-label">Descendante<br><input type="number" id="coeff-descendante" value="2" min="1" max="9"></span>
			</div>

            <button type="submit" class="yams-btn">Lancer la partie</button>
        </form>
    </div>
</div>

<script>
function updateFields() {
    const numPlayers = parseInt(document.getElementById('num_players').value, 10);
    // CORRECTION : minTeams = 1 !
    const minTeams = 1;
    const numTeamsSelect = document.getElementById('num_teams');
    numTeamsSelect.innerHTML = "";
    for(let t = minTeams; t <= numPlayers; t++) {
        numTeamsSelect.innerHTML += `<option value="${t}" ${t===2?'selected':''}>${t}</option>`;
    }
    let numTeams = parseInt(numTeamsSelect.value, 10);
    let teamNamesHtml = '';
    for (let i = 1; i <= numTeams; i++) {
        teamNamesHtml += `<span class="team-label">Équipe ${i}: <input type="text" class="team-name-input" id="team-name-${i}" value="Equipe ${i}" required></span>`;
    }
    document.getElementById('team-names-row').innerHTML = teamNamesHtml;
    let html = '';
    for (let i = 0; i < numPlayers; i++) {
        html += `<div class="team-inputs"><input type="text" name="player${i}" placeholder="Nom du joueur ${i+1}" required>
        <select class="player-team-select" name="player_team${i}">`;
        for (let t = 1; t <= numTeams; t++) {
            html += `<option value="${t}">Équipe ${t}</option>`;
        }
        html += `</select></div>`;
    }
    document.getElementById('players-fields').innerHTML = html;
}
updateFields();

document.getElementById('num_players').addEventListener('change', updateFields);
document.getElementById('num_teams').addEventListener('change', updateFields);

document.getElementById('config-form').addEventListener('submit', function(e) {
    e.preventDefault();
    let numPlayers = parseInt(document.getElementById('num_players').value, 10);
    let numTeams = parseInt(document.getElementById('num_teams').value, 10);

    let teams = [];
    let teamNames = [];
    for (let t = 1; t <= numTeams; t++) {
        let teamName = document.getElementById(`team-name-${t}`).value.trim() || `Equipe ${t}`;
        teams.push(teamName);
        teamNames.push(teamName);
    }
    let players = [];
    let teamPlayerCount = {};
    for (let i = 0; i < numPlayers; i++) {
        let name = document.querySelector(`[name="player${i}"]`).value.trim();
        let teamIdx = parseInt(document.querySelector(`[name="player_team${i}"]`).value, 10) - 1;
        let team = teamNames[teamIdx];
        teamPlayerCount[team] = (teamPlayerCount[team] || 0) + 1;
        if (teamPlayerCount[team] > 2) {
            alert("Pas plus de 2 joueurs par équipe.");
            return;
        }
        players.push({ name, team });
    }
    // Premier joueur de chaque équipe
    let firstMain = [];
    for (let t = 0; t < teamNames.length; t++) {
        let joueurEquipe = players.find(p => p.team === teamNames[t]);
        if (joueurEquipe) firstMain.push(joueurEquipe.name);
    }
    // Ajout : coefficients dans l'objet envoyé
    const coeffs = {
        montante: parseInt(document.getElementById("coeff-montante").value, 10),
        libre: parseInt(document.getElementById("coeff-libre").value, 10),
        seche: parseInt(document.getElementById("coeff-seche").value, 10),
        descendante: parseInt(document.getElementById("coeff-descendante").value, 10),
    };

    fetch('/config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            teams: teams,
            players: players,
            firstMain: firstMain,
            coeffs: coeffs
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.location.href = '/game';
        } else {
            alert("Erreur de configuration.");
        }
    });
});
</script>
</body>
</html>
