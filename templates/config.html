<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>YAM's - Feuille de Score</title>

    <!-- Manifest (Android/Chrome) -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}?v=1">
    <meta name="theme-color" content="#181b20">

    <!-- iOS (ajout à l’écran d’accueil) -->
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/icon-180.png') }}?v=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Favicon navigateur desktop -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}?v=2">
	<link rel="icon" type="image/png" href="{{ url_for('static', filename='icons/favicon-32.png') }}?v=3" sizes="32x32">
    <link rel="alternate icon" href="{{ url_for('static', filename='icons/icon-192.png') }}?v=2">

    <!-- Ton CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

<div id="splash" role="dialog" aria-modal="true" aria-label="Écran d’introduction">
  <div class="yui-panel">
    <img class="yui-mark" alt="" src="{{ url_for('static', filename='icons/icon-192.png') }}">
    <h1 class="yui-title">YAM’s<br>Feuille de score 4 colonnes</h1>
    <p class="yui-sub">Parties en équipe, rotation de la première main, saisie guidée. Préparez vos dés 🎲</p>
    <div class="yui-meta"><span>v1.0</span> • <span>RL</span></div>
    <button class="yui-btn" id="splash-go">GO!</button>
  </div>
</div>


<div class="main-container">
  <div class="config-box">
    <h1>Configurer la partie Yam's</h1>

    <div class="config-hero">
      <h2>Bienvenue 👋</h2>
      <p>Bienvenue sur l’app des feuilles de score du Yam’s.</p>
      <p>Pour commencer, vous devez configurer votre partie. On vous guide pas à pas !</p>
    </div>

    <form id="config-form" autocomplete="off">

      <!-- Étape 1 -->
      <h3 class="config-sub">1) Choisir le nombre de joueurs et d’équipes</h3>
      <label for="num_players">Nombre de joueurs :</label>
      <select name="num_players" id="num_players" required onchange="updateFields()">
        <option value="1">1</option>
        <option value="2" selected>2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
      </select>

      <label for="num_teams" style="margin-left:18px;">Nombre d'équipes :</label>
      <select name="num_teams" id="num_teams" required onchange="updateFields()"></select>

      <!-- Étape 2 -->
      <h3 class="config-sub">2) Nommer les équipes</h3>
      <div class="team-names-row" id="team-names-row"></div>

      <!-- Étape 3 -->
      <h3 class="config-sub">3) Saisir les joueurs et les affecter à une équipe</h3>
      <div id="players-fields"></div>

      <!-- Étape 4 -->
      <h3 class="config-sub">4) Ajuster les coefficients (optionnel)</h3>
      <div class="coeffs-box">
        <label class="coeff-label">Montante
          <input type="number" id="coeff-montante" value="3" min="1">
        </label>
        <label class="coeff-label">Libre
          <input type="number" id="coeff-libre" value="1" min="1">
        </label>
        <label class="coeff-label">Sèche
          <input type="number" id="coeff-seche" value="4" min="1">
        </label>
        <label class="coeff-label">Descendante
          <input type="number" id="coeff-descendante" value="2" min="1">
        </label>
      </div>

      <!-- Étape 5 -->
      <h3 class="config-sub">5) Lancer la partie</h3>
      <button type="submit" class="yams-btn">C'est parti 🎲</button>
    </form>
  </div>
</div>


<script>
function updateFields() {
	const numPlayers = parseInt(document.getElementById('num_players').value, 10);
    const minTeams = Math.ceil(numPlayers / 2);
    const maxTeams = numPlayers;

    const numTeamsSelect = document.getElementById('num_teams');

    // Sauvegarder la valeur actuelle AVANT de vider
    const oldVal = parseInt(numTeamsSelect.value, 10);

    // Réinitialiser
    numTeamsSelect.innerHTML = "";

    for (let t = minTeams; t <= maxTeams; t++) {
        numTeamsSelect.innerHTML += `<option value="${t}" ${t === oldVal ? 'selected' : ''}>${t}</option>`;
    }

    let numTeams = parseInt(numTeamsSelect.value, 10);
    let teamNamesHtml = '';
    for (let i = 1; i <= numTeams; i++) {
        teamNamesHtml += `<span class="team-label">Équipe ${i} : 
            <input type="text" class="team-name-input" id="team-name-${i}" value="Equipe ${i}" required>
        </span>`;
    }
    document.getElementById('team-names-row').innerHTML = teamNamesHtml;
    let html = '';
    for (let i = 0; i < numPlayers; i++) {
        html += `<div class="team-inputs"><input type="text" name="player${i}" placeholder="Nom du joueur ${i+1}" required>
        <select class="player-team-select" name="player_team${i}">`;
        for (let t = 1; t <= numTeams; t++) {
            html += `<option value="${t}">Équipe ${t}</option>`;
        }
        html += `</select></div>`;
    }
    document.getElementById('players-fields').innerHTML = html;
}
updateFields();

document.getElementById('num_players').addEventListener('change', updateFields);
document.getElementById('num_teams').addEventListener('change', updateFields);

document.getElementById('config-form').addEventListener('submit', function(e) {
    e.preventDefault();
    let numPlayers = parseInt(document.getElementById('num_players').value, 10);
    let numTeams = parseInt(document.getElementById('num_teams').value, 10);

    // Création d'un objet teams { "Equipe 1": [] }
    let teamsObj = {};
    for (let t = 1; t <= numTeams; t++) {
        let teamName = document.getElementById(`team-name-${t}`).value.trim() || `Equipe ${t}`;
        teamsObj[teamName] = [];
    }

    let players = [];
    let teamPlayerCount = {};
    for (let i = 0; i < numPlayers; i++) {
        let name = document.querySelector(`[name="player${i}"]`).value.trim();
        let teamIdx = parseInt(document.querySelector(`[name="player_team${i}"]`).value, 10) - 1;
        let teamName = Object.keys(teamsObj)[teamIdx];

        teamPlayerCount[teamName] = (teamPlayerCount[teamName] || 0) + 1;
        if (teamPlayerCount[teamName] > 2) {
            alert("Pas plus de 2 joueurs par équipe.");
            return;
        }

        players.push(name);
        teamsObj[teamName].push(name);
    }

    // Premier joueur de chaque équipe
    let firstMain = {};
    Object.keys(teamsObj).forEach(team => {
        firstMain[team] = 0; // index du premier joueur dans la liste
    });

    const coeffs = {
        montante: parseInt(document.getElementById("coeff-montante").value, 10),
        libre: parseInt(document.getElementById("coeff-libre").value, 10),
        seche: parseInt(document.getElementById("coeff-seche").value, 10),
        descendante: parseInt(document.getElementById("coeff-descendante").value, 10),
    };

    fetch('/config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            teams: teamsObj,  // ← objet bien formaté
            players: players, // liste simple
            firstMain: firstMain,
            coeffs: coeffs
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            window.location.href = `/game/${data.game_id}`;
        } else {
            alert("Erreur de configuration.");
        }
    });
});

</script>

<script>
  document.documentElement.classList.add('splash-lock');
  document.body.classList.add('splash-lock');

  const splash = document.getElementById('splash');
  const goBtn  = document.getElementById('splash-go');

  function closeSplash(){
    splash?.classList.add('yui-hide');
    document.documentElement.classList.remove('splash-lock');
    document.body.classList.remove('splash-lock');
  }

  goBtn?.addEventListener('click', closeSplash);
</script>


</body>
</html>



