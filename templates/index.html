<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>YAM's - Feuille de Score</title>

    <!-- Manifest (Android/Chrome) -->
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}?v=1">
    <meta name="theme-color" content="#181b20">

    <!-- iOS (ajout Ã  lâ€™Ã©cran dâ€™accueil) -->
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/icon-180.png') }}?v=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	
	<!-- Android / Chrome -->
	<meta name="mobile-web-app-capable" content="yes">

    <!-- Favicon navigateur desktop -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}?v=2">
	<link rel="icon" type="image/png" href="{{ url_for('static', filename='icons/favicon-32.png') }}?v=3" sizes="32x32">
    <link rel="alternate icon" href="{{ url_for('static', filename='icons/icon-192.png') }}?v=2">

    <!-- Ton CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="game-page">

<div id="splash" role="dialog" aria-modal="true" aria-label="Ã‰cran dâ€™introduction">
  <div class="yui-panel">
    <img class="yui-mark" alt="" src="{{ url_for('static', filename='icons/icon-192.png') }}">
    <h1 class="yui-title">YAMâ€™s<br>Feuille de score 4 colonnes</h1>
    <p class="yui-sub">Parties en Ã©quipe, rotation de la premiÃ¨re main, saisie guidÃ©e. PrÃ©parez vos dÃ©s ðŸŽ²</p>
    <div class="yui-meta"><span>v1.0</span> â€¢ <span>RL</span></div>
    <button class="yui-btn" id="splash-go">GO!</button>
  </div>
</div>




<div class="main-container">
    <h1>Yam's - Feuille de Score</h1>
	
	<!-- BARRE Dâ€™ACTIONS COMPACTE -->
	<div class="game-actions" role="toolbar" aria-label="Actions de la partie">
	<!-- Accueil -->
	<button class="ico-btn" id="btn-home" title="Retour Ã  lâ€™accueil" onclick="window.location.href='/'" aria-label="Accueil">
    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3z"/></svg>
	</button>

	<!-- Recommencer -->
	<button class="ico-btn" id="restart-btn" title="Recommencer (rÃ©initialiser les grilles)" aria-label="Recommencer">
    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 6V3l-4 4l4 4V8a5 5 0 1 1-5 5H5a7 7 0 1 0 7-7z"/></svg>
	</button>

	<!-- Annuler dernier coup -->
	<button class="ico-btn primary" id="undo-btn" title="Annuler le dernier coup" aria-label="Annuler le dernier coup">
	<svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 5V1L7 6l5 5V7a6 6 0 0 1 6 6a6 6 0 0 1-6 6H6v2h6a8 8 0 0 0 0-16z"/></svg>
	</button>

	<!-- Ouvrir la popup ThÃ¨mes -->
	<button class="ico-btn" id="btn-theme" title="ThÃ¨me" aria-haspopup="dialog" aria-controls="themeModal" aria-label="Choisir un thÃ¨me">
    <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 3a9 9 0 0 0 0 18h2.5a2.5 2.5 0 0 0 0-5H14a1 1 0 0 1-1-1c0-.9.5-1.4 1.4-2.3c1-1 1.6-1.7 1.6-3.2A6.5 6.5 0 0 0 9.5 3zM7 8a1.5 1.5 0 1 1 3 0a1.5 1.5 0 0 1-3 0m6-1a1.5 1.5 0 1 1 0 3a1.5 1.5 0 0 1 0-3M6.5 12A1.5 1.5 0 1 1 5 13.5A1.5 1.5 0 0 1 6.5 12"/></svg>
	</button>
	
    <!-- Export JSON -->
    <button class="ico-btn" id="btn-export" title="Exporter la partie" aria-label="Exporter">
      <svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M5 20h14v-2H5v2zM5 4v8h3v6h8v-6h3V4H5zm8 12h-2v-6H8l4-4l4 4h-3v6z"/></svg>
    </button>
    <!-- Import JSON -->
    <button class="ico-btn" id="btn-import" title="Importer une partie" aria-label="Importer">
      <svg width="20" height="20" viewBox="0 0 24 24"><path fill="currentColor" d="M19 13v6H5v-6H3v8h18v-8h-2zM11 3v10l-4-4H5l7 7l7-7h-2l-4 4V3h-2z"/></svg>
    </button>
    <input type="file" id="importFile" accept="application/json" style="display:none">
</div>

<div id="scores-box"></div>
<div class="grids-flex" id="grids-container"></div>

</div>

<!-- POPUP / MODAL DE THÃˆME -->
<div id="themeModal" class="theme-modal" role="dialog" aria-modal="true" aria-labelledby="themeTitle" hidden>
  <div class="theme-panel">
    <div class="theme-head">
      <h3 id="themeTitle">Choisir un thÃ¨me</h3>
      <button class="ico-btn ghost" id="closeTheme" title="Fermer" aria-label="Fermer">
        <svg width="18" height="18" viewBox="0 0 24 24"><path fill="currentColor" d="M18.3 5.71L12 12.01l-6.3-6.3l-1.4 1.41L10.59 13.4l-6.3 6.3l1.41 1.41l6.3-6.29l6.3 6.3l1.41-1.42l-6.29-6.3l6.3-6.29z"/></svg>
      </button>
    </div>
    <form id="themeForm" class="theme-list">
      <label><input type="radio" name="theme" value="classic"> Classic</label>
      <label><input type="radio" name="theme" value="ocean"> Ocean</label>
      <label><input type="radio" name="theme" value="solar"> Solar (clair)</label>
      <label><input type="radio" name="theme" value="emerald"> Emerald</label>
      <label><input type="radio" name="theme" value="mono"> Mono</label>
      <label><input type="radio" name="theme" value="photo"> Photo</label>
    </form>
    <div class="theme-actions">
      <button class="btn" id="cancelTheme">Annuler</button>
      <button class="btn primary" id="applyTheme">Appliquer</button>
    </div>
  </div>
</div>


<script>
    const GAME_ID = "{{ game_id }}";
	const RESET_URL = "{{ url_for('reset_game', game_id=game_id) }}";
</script>

<script src="{{ url_for('static', filename='script.js') }}"></script>

<script>
  document.documentElement.classList.add('splash-lock');
  document.body.classList.add('splash-lock');

  const splash = document.getElementById('splash');
  const goBtn  = document.getElementById('splash-go');

  function closeSplash(){
    splash?.classList.add('yui-hide');
    document.documentElement.classList.remove('splash-lock');
    document.body.classList.remove('splash-lock');
  }

  goBtn?.addEventListener('click', closeSplash);
</script>

<!-- <script>
  // Applique le thÃ¨me au <html>
  const html = document.documentElement;
  const select = document.getElementById('themeSelect');
  // valeur en mÃ©moire si dÃ©jÃ  choisie
  const saved = localStorage.getItem('yams-theme') || 'classic';
  html.setAttribute('data-theme', saved);
  if (select) select.value = saved;

  select?.addEventListener('change', () => {
    const val = select.value;
    html.setAttribute('data-theme', val);
    localStorage.setItem('yams-theme', val);
  });
</script> -->


<!-- <script>
  document.getElementById('restart-btn')?.addEventListener('click', async () => {
    try {
      const btn = document.getElementById('restart-btn');
      btn.disabled = true; btn.textContent = "RÃ©initialisationâ€¦";

      const r = await fetch(RESET_URL, { method: 'POST' });
      if (!r.ok) throw new Error(await r.text());

      window.location.reload();
    } catch (e) {
      alert("Ã‰chec de la rÃ©initialisation : " + (e?.message || e));
      const btn = document.getElementById('restart-btn');
      btn.disabled = false; btn.textContent = "Recommencer";
    }
  });
</script> -->

<script>
  // â€”â€”â€”â€”â€” ThÃ¨mes via popup â€”â€”â€”â€”â€”
  const htmlEl = document.documentElement;
  const modal = document.getElementById('themeModal');
  const btnTheme = document.getElementById('btn-theme');
  const closeTheme = document.getElementById('closeTheme');
  const cancelTheme = document.getElementById('cancelTheme');
  const applyTheme = document.getElementById('applyTheme');
  const themeForm = document.getElementById('themeForm');

  function openTheme(){
    // coche le thÃ¨me courant
    const cur = localStorage.getItem('yams-theme') || htmlEl.getAttribute('data-theme') || 'classic';
    [...themeForm.elements.theme].forEach(r => r.checked = (r.value === cur));
    modal.hidden = false;
  }
  function closeThemeModal(){ modal.hidden = true; }

  btnTheme?.addEventListener('click', openTheme);
  closeTheme?.addEventListener('click', closeThemeModal);
  cancelTheme?.addEventListener('click', (e)=>{ e.preventDefault(); closeThemeModal(); });

  applyTheme?.addEventListener('click', (e)=>{
    e.preventDefault();
    const val = [...themeForm.elements.theme].find(r => r.checked)?.value || 'classic';
    htmlEl.setAttribute('data-theme', val);
    localStorage.setItem('yams-theme', val);
    closeThemeModal();
  });

  // Ã‰chap pour fermer
	window.addEventListener('keydown', (e)=>{ if(!modal.hidden && e.key==='Escape'){ closeThemeModal(); } });
  
  // Fermer si clic sur lâ€™arriÃ¨re-plan
	modal.addEventListener('click', (e) => {
	if (e.target === modal) closeThemeModal();
	});
	
	btnTheme?.addEventListener('click', () => {
	// Si le splash est visible, on ne fait rien
	if (!splash.classList.contains('yui-hide')) return;
	openTheme();
	});

  // â€”â€”â€”â€”â€” Recommencer (ta route / reset est dÃ©jÃ  en place) â€”â€”â€”â€”â€”
  document.getElementById('restart-btn')?.addEventListener('click', async () => {
    const btn = document.getElementById('restart-btn');
    try{
      btn.disabled = true; btn.title = "RÃ©initialisationâ€¦";
      <!-- const r = await fetch("{{ url_for('reset_game', game_id=game_id) }}", { method:'POST' }); -->
	  const r = await fetch(RESET_URL, { method:'POST' });
      if(!r.ok) throw new Error(await r.text());
      window.location.reload();
    }catch(e){
      alert("Ã‰chec de la rÃ©initialisation : " + (e?.message || e));
      btn.disabled = false; btn.title = "Recommencer";
    }
  });

	// â€”â€”â€”â€”â€” ThÃ¨me courant au chargement â€”â€”â€”â€”â€”
	(function initTheme(){
    let val = localStorage.getItem('yams-theme');
    if (!val) {
        val = 'photo'; // ðŸ‘ˆ par dÃ©faut : photo
        localStorage.setItem('yams-theme', val);
    }
    htmlEl.setAttribute('data-theme', val);
})();

</script>




<script>
(function(){
  // --- EXPORT avec nom ---
  document.getElementById('btn-export')?.addEventListener('click', ()=>{
    const data = localStorage.getItem(`yams:state:${GAME_ID}`) || "{}";

    // Nom prÃ©cÃ©dent mÃ©morisÃ© (ou noms d'Ã©quipes comme suggestion)
    let previous = localStorage.getItem('yams-save-name') || '';
    try {
      const st = JSON.parse(data);
      if (!previous && st && st.teams) previous = Object.keys(st.teams).join('-');
    } catch(e){}

    const name = prompt("Nom de la sauvegarde :", previous || "yams");
    if (name) localStorage.setItem('yams-save-name', name);

    // Nettoyage: accents/espaces/ponctuation â†’ slug
    const strip = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const safe  = strip((name || 'yams')).trim().toLowerCase()
                    .replace(/[^a-z0-9-_\s]/gi,'')
                    .replace(/\s+/g,'-');

    const stamp = new Date().toISOString().slice(0,10); // YYYY-MM-DD
    const blob = new Blob([data], {type: 'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `${safe}-${stamp}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // --- IMPORT en jeu (rÃ©-ensemence le serveur + refresh) ---
  const inputFile = document.getElementById('importFile');
  document.getElementById('btn-import')?.addEventListener('click', ()=> inputFile && inputFile.click());
  inputFile?.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0];
    if(!file) return;
    try{
      const st = JSON.parse(await file.text());
      localStorage.setItem(`yams:state:${GAME_ID}`, JSON.stringify(st));
      try {
        await fetch(`/sync_state/${GAME_ID}`, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(st)
        });
      } catch(e){}
      if (typeof fetchState === 'function') fetchState();
      else if (typeof renderAllGrids === 'function') renderAllGrids(st);
    }catch(err){
      alert("Fichier invalide.");
    }
  });
})();
</script>
</body>
</html>
